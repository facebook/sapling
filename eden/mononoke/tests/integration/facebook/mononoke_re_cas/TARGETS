load("@fbcode//target_determinator/macros:ci_hint.bzl", "ci_hint")
load(
    "//eden/mononoke/tests/integration/facebook:fb_manifest_deps.bzl",
    "dott_test",
)

oncall("scm_server_infra")

# Test suit for testing of Mononoke CAS Sync and also
# for testing Sapling/Cas integration when a repo is synced

# TODO(liubovd): fix flaky LFS test
dott_test(
    name = "mononoke_re_cas",
    disable_all_network_access_target = False,
    dott_files = glob(
        [
            "*.t",
        ],
        exclude = ["test-sapling-cas-lfs-goto.t"],
    ),
    deps = [
        "//eden/mononoke:mononoke",
        "//eden/mononoke/lfs_server:lfs_server",
        "//eden/mononoke/mononoke_cas_sync_job:mononoke_cas_sync_job",
        "//eden/mononoke/tools/admin:newadmin",
        "//eden/mononoke/tools/testtool:testtool",
    ],
)

# This adds some artificial direct dependecies to CI graph to make it look like deps are closer
ci_hint(
    ci_deps = [
        "fbcode//remote_execution/client_lib/wrappers/rust:re_client_lib",
        "fbcode//remote_execution/client_lib/wrappers/rust:external_re_client_lib",
    ],
    ci_srcs = ["fbcode/eden/scm/**"],
    reason = "Those tests should be triggered on sapling and RE diffs despite the longer CI distance",
    target = "mononoke_re_cas",
)
