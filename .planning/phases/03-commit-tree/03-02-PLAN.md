---
phase: 03-commit-tree
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - addons/isl/src/Avatar.tsx
  - addons/isl/src/Commit.tsx
  - addons/isl/src/CommitTreeList.css
autonomous: true

must_haves:
  truths:
    - "Each commit in the tree displays the author's avatar or initials"
    - "Avatar is small (20px) and doesn't dominate the commit row"
    - "Missing avatar photos show colored initials circle"
    - "Same author always gets same color for initials"
  artifacts:
    - path: "addons/isl/src/Avatar.tsx"
      provides: "CommitAvatar component with InitialsAvatar fallback"
      exports: ["CommitAvatar", "InitialsAvatar"]
    - path: "addons/isl/src/Commit.tsx"
      provides: "Author avatar display in commit row"
      contains: "CommitAvatar"
    - path: "addons/isl/src/CommitTreeList.css"
      provides: "Avatar styling"
      contains: "commit-author-avatar"
  key_links:
    - from: "Commit.tsx"
      to: "CommitAvatar"
      via: "import and render"
      pattern: "CommitAvatar.*username"
    - from: "CommitAvatar"
      to: "avatarUrl atom"
      via: "useAtomValue"
      pattern: "useAtomValue.*avatarUrl"
---

<objective>
Add author avatar display to commits in the tree, with initials fallback for missing photos.

Purpose: Users see who authored each commit at a glance. Small avatar circles (20px) show author identity without dominating the row. When avatar photos aren't available, colored initials provide consistent visual identity.

Output: Extended Avatar.tsx with CommitAvatar and InitialsAvatar, updated Commit.tsx to display avatar, supporting CSS.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-commit-tree/03-CONTEXT.md
@.planning/phases/03-commit-tree/03-RESEARCH.md

@addons/isl/src/Avatar.tsx
@addons/isl/src/Commit.tsx
@addons/isl/src/CommitTreeList.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CommitAvatar with InitialsAvatar fallback</name>
  <files>addons/isl/src/Avatar.tsx</files>
  <action>
Add to Avatar.tsx:

1. Define color palette for initials (12 colors for good distribution):
```typescript
const AVATAR_COLORS = [
  '#e91e63', '#9c27b0', '#673ab7', '#3f51b5',
  '#2196f3', '#00bcd4', '#009688', '#4caf50',
  '#ff9800', '#ff5722', '#795548', '#607d8b'
];
```

2. Add hash function for consistent colors:
```typescript
function hashStringToColor(str: string): string {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = str.charCodeAt(i) + ((hash << 5) - hash);
  }
  return AVATAR_COLORS[Math.abs(hash) % AVATAR_COLORS.length];
}

function getInitials(username: string): string {
  // Extract username from email if present
  const name = username.split('@')[0];
  return name.slice(0, 2).toUpperCase();
}
```

3. Create InitialsAvatar component:
```typescript
export function InitialsAvatar({username, size = 20}: {username: string; size?: number}) {
  const initials = getInitials(username);
  const bgColor = hashStringToColor(username);

  return (
    <div
      className="avatar-initials"
      style={{
        backgroundColor: bgColor,
        width: size,
        height: size,
        borderRadius: '50%',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        fontSize: size * 0.5,
        fontWeight: 600,
        color: 'white',
        flexShrink: 0,
      }}
      title={username}
    >
      {initials}
    </div>
  );
}
```

4. Create CommitAvatar that uses existing Avatar infrastructure with InitialsAvatar fallback:
```typescript
export function CommitAvatar({username, size = 20}: {username: string; size?: number}) {
  const url = useAtomValue(avatarUrl(username));

  if (url) {
    return (
      <AvatarImg
        url={url}
        username={username}
        width={size}
        height={size}
        className="commit-author-avatar"
      />
    );
  }

  return <InitialsAvatar username={username} size={size} />;
}
```

Note: Need to export the existing `avatarUrl` atom family so CommitAvatar can use it.
  </action>
  <verify>
1. Run `cd /Users/jonas/code/sapling/addons/isl && yarn eslint src/Avatar.tsx --fix`
2. Run `cd /Users/jonas/code/sapling/addons/isl && yarn build` to ensure no TypeScript errors
  </verify>
  <done>
- InitialsAvatar component exported
- CommitAvatar component exported
- Hash function produces consistent colors
- No lint or type errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add avatar to commit rows</name>
  <files>addons/isl/src/Commit.tsx, addons/isl/src/CommitTreeList.css</files>
  <action>
In Commit.tsx:

1. Import CommitAvatar:
```typescript
import {CommitAvatar} from './Avatar';
```

2. In the Commit component's render, add avatar before the commit title (inside commit-details, after the IrrelevantCwdIcon check). Find this section:
```tsx
{isPublic ? null : (
  <span className="commit-title">
    {commitLabel && <CommitLabel>{commitLabel}</CommitLabel>}
    <span>{title}</span>
    <CommitDate date={commit.date} />
  </span>
)}
```

Add the avatar before commit-title span:
```tsx
{isPublic ? null : (
  <>
    <CommitAvatar username={commit.author} size={20} />
    <span className="commit-title">
      {commitLabel && <CommitLabel>{commitLabel}</CommitLabel>}
      <span>{title}</span>
      <CommitDate date={commit.date} />
    </span>
  </>
)}
```

In CommitTreeList.css, add avatar styling:
```css
/* Commit author avatar */
.commit-author-avatar {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  flex-shrink: 0;
}

.avatar-initials {
  flex-shrink: 0;
}
```
  </action>
  <verify>
1. Run `cd /Users/jonas/code/sapling/addons/isl && yarn eslint src/Commit.tsx --fix`
2. Run `cd /Users/jonas/code/sapling/addons/isl && yarn build` to ensure no TypeScript errors
3. Visual check: Start dev server, verify avatars appear next to commit titles
  </verify>
  <done>
- CommitAvatar imported and rendered in Commit component
- Avatar appears before commit title for non-public commits
- Avatar is 20px and circular
- Initials fallback works for missing avatars
  </done>
</task>

</tasks>

<verification>
1. Start dev server: `cd /Users/jonas/code/sapling/addons && yarn dev`
2. Open ISL in browser
3. Verify each commit shows a small avatar circle (20px) before the title
4. Check that different authors have different colored initials
5. Verify same author always has same color (refresh page, should be consistent)
6. Check avatar doesn't dominate the row - should be compact
</verification>

<success_criteria>
- Each commit displays author avatar (20px circle)
- Missing photos show initials in colored circle
- Same author always gets same color (deterministic hash)
- Avatar positioned before commit title
- No lint or build errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-commit-tree/03-02-SUMMARY.md`
</output>
