---
phase: 01-layout-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - addons/isl/src/drawerState.ts
  - addons/isl/src/responsive.tsx
  - addons/isl/src/Drawers.tsx
autonomous: true

must_haves:
  truths:
    - "Details panel (right drawer) auto-hides when window width drops below 1200px"
    - "Stack panel (left drawer) auto-hides when window width drops below 800px"
    - "Manually collapsed drawers stay collapsed even when window widens"
    - "Auto-collapsed drawers auto-expand when window widens past threshold"
  artifacts:
    - path: "addons/isl/src/responsive.tsx"
      provides: "Breakpoint constants and auto-collapse state atoms"
      contains: "DETAILS_PANEL_BREAKPOINT"
    - path: "addons/isl/src/drawerState.ts"
      provides: "Auto-collapse tracking state"
      contains: "autoCollapsedState"
    - path: "addons/isl/src/Drawers.tsx"
      provides: "useAutoCollapseDrawers hook integration"
      contains: "useAutoCollapseDrawers"
  key_links:
    - from: "addons/isl/src/Drawers.tsx"
      to: "addons/isl/src/drawerState.ts"
      via: "Jotai atoms for drawer and auto-collapse state"
      pattern: "useAtom.*islDrawerState|useAtom.*autoCollapsedState"
    - from: "addons/isl/src/drawerState.ts"
      to: "addons/isl/src/responsive.tsx"
      via: "Breakpoint constants and width state"
      pattern: "mainContentWidthState|DETAILS_PANEL_BREAKPOINT"
---

<objective>
Implement responsive auto-collapse behavior for the three-column layout.

Purpose: Users on narrower screens need the UI to gracefully adapt by hiding less-critical panels, while respecting their manual collapse preferences.

Output: Working responsive breakpoints at 1200px (details panel) and 800px (stack panel), with smart restore behavior that distinguishes manual vs auto-collapse.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-layout-foundation/01-CONTEXT.md
@.planning/phases/01-layout-foundation/01-RESEARCH.md

# Key existing files
@addons/isl/src/Drawers.tsx
@addons/isl/src/drawerState.ts
@addons/isl/src/responsive.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add breakpoint constants and auto-collapse state</name>
  <files>addons/isl/src/responsive.tsx, addons/isl/src/drawerState.ts</files>
  <action>
In `responsive.tsx`:
1. Add breakpoint constants:
   - `DETAILS_PANEL_BREAKPOINT = 1200` (right drawer hides below this)
   - `STACK_PANEL_BREAKPOINT = 800` (left drawer hides below this)

2. Add derived atom `shouldAutoCollapseDrawers` that reads `mainContentWidthState` and returns `{right: boolean, left: boolean}` based on breakpoints.

In `drawerState.ts`:
3. Add new Jotai atom `autoCollapsedState` to track whether each drawer was auto-collapsed vs manually collapsed:
   ```typescript
   export const autoCollapsedState = atom({
     right: false,
     left: false,
   });
   ```

4. Remove or disable the existing `autoCloseBasedOnWindowWidth()` function and its window.resize listener (lines 28-66) — we're replacing this with the ResizeObserver-based approach.

IMPORTANT: Keep the `islDrawerState` atom and its localStorage persistence unchanged. Only add the new `autoCollapsedState` atom alongside it.
  </action>
  <verify>
1. `grep -n "DETAILS_PANEL_BREAKPOINT\|STACK_PANEL_BREAKPOINT" addons/isl/src/responsive.tsx` shows both constants
2. `grep -n "autoCollapsedState" addons/isl/src/drawerState.ts` shows the new atom
3. `yarn tsc --noEmit` in addons/ passes with no type errors
  </verify>
  <done>
- Breakpoint constants exist at 1200px and 800px
- Auto-collapse tracking atom exists
- Old window.resize-based auto-close is disabled
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement useAutoCollapseDrawers hook and integrate</name>
  <files>addons/isl/src/Drawers.tsx</files>
  <action>
1. Create `useAutoCollapseDrawers()` hook in Drawers.tsx (or responsive.tsx if cleaner):
   - Import `shouldAutoCollapseDrawers` from responsive.tsx
   - Import `islDrawerState` and `autoCollapsedState` from drawerState.ts
   - Use `useAtomValue` for derived state, `useAtom` for writable state

2. Hook logic (in useEffect):
   - When `shouldAutoCollapse.right` is true AND drawer is NOT already collapsed:
     - Collapse the right drawer
     - Set `autoCollapsedState.right = true`
   - When `shouldAutoCollapse.right` is false AND drawer IS collapsed AND `autoCollapsedState.right` is true:
     - Expand the right drawer
     - Set `autoCollapsedState.right = false`
   - Same logic for left drawer with its breakpoint

3. When user MANUALLY toggles a drawer (clicks the drawer label):
   - Set `autoCollapsedState[side] = false` — this prevents auto-expansion

4. Integrate the hook by calling `useAutoCollapseDrawers()` inside the `Drawers` component.

5. The existing `onClick` handler in the Drawer component (line 161) needs to also reset the autoCollapsed flag for that drawer when manually toggling:
   - When user clicks to collapse: set autoCollapsed[side] = false (so it won't auto-expand)
   - When user clicks to expand: set autoCollapsed[side] = false (so it stays expanded)

AVOID: Don't remove or break existing resize drag functionality. Don't change the localStorage persistence. Don't remove the existing `islDrawerState` atom structure.
  </action>
  <verify>
1. `yarn dev` in addons/isl/ — application starts without errors
2. Resize browser window to <1200px — right panel should auto-collapse
3. Resize window back to >1200px — right panel should auto-expand
4. Manually collapse right panel, then resize narrow and wide — panel stays collapsed
5. `yarn tsc --noEmit` passes
  </verify>
  <done>
- useAutoCollapseDrawers hook exists and is called in Drawers component
- Right drawer auto-collapses below 1200px
- Left drawer auto-collapses below 800px
- Manual collapse overrides auto-collapse (stays collapsed when widening)
- Auto-collapsed drawers auto-expand when window widens
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Breakpoint verification:**
   - Start dev server: `cd addons && yarn dev`
   - Open http://localhost:3000 (or ISL port)
   - Resize browser window width and observe:
     - Width > 1200px: both panels visible (if not manually collapsed)
     - Width 800-1200px: right panel auto-hidden, left visible
     - Width < 800px: both panels auto-hidden

2. **Smart restore verification:**
   - With width > 1200px, manually collapse right panel (click label)
   - Resize to < 1200px, then back to > 1200px
   - Right panel should remain collapsed (user preference respected)

3. **Auto-restore verification:**
   - With width > 1200px, ensure right panel is expanded
   - Resize to < 1200px (auto-collapses)
   - Resize back to > 1200px
   - Right panel should auto-expand

4. **No regressions:**
   - Manual drag-resize of panels still works
   - Drawer state persists across page reload
   - No console errors during resize operations
</verification>

<success_criteria>
- Layout collapses gracefully when window is narrowed below threshold (LAYOUT-01)
- Details panel hides at 1200px, stack panel hides at 800px
- Smart restore: manual collapses respected, auto-collapses auto-restored
- Existing functionality preserved (drag resize, persistence, manual toggle)
- No TypeScript errors, no console errors during operation
</success_criteria>

<output>
After completion, create `.planning/phases/01-layout-foundation/01-01-SUMMARY.md`
</output>
