---
phase: 02-stack-column
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - addons/isl/src/PRDashboard.tsx
  - addons/isl/src/PRDashboard.css
autonomous: true

must_haves:
  truths:
    - "Main branch section appears fixed at top of PR stack column"
    - "Main section has 'Go to main' button that pulls and checks out"
    - "Main section shows sync status (behind by X commits or up to date)"
    - "Stack items scroll beneath the fixed main section"
    - "Main section is visually distinct but not dramatically different from stack cards"
  artifacts:
    - path: "addons/isl/src/PRDashboard.tsx"
      provides: "MainBranchSection component at top of PRDashboard"
      exports: ["PRDashboard"]
    - path: "addons/isl/src/PRDashboard.css"
      provides: "Sticky positioning and styling for main section"
      contains: "position: sticky"
  key_links:
    - from: "addons/isl/src/PRDashboard.tsx"
      to: "PullOperation + GotoOperation"
      via: "useRunOperation for go-to-main action"
      pattern: "runOperation.*PullOperation|GotoOperation"
---

<objective>
Add fixed main branch section at top of stack column

Purpose: Users see main branch prominently at the top of the stack column with a single "Go to main" action that pulls and checks out. Shows sync status so users know if they need to update.

Output: PRDashboard with sticky main branch section at top showing sync status and go-to-main button
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-stack-column/02-CONTEXT.md
@.planning/phases/02-stack-column/02-RESEARCH.md

@addons/isl/src/PRDashboard.tsx
@addons/isl/src/PRDashboard.css
@addons/isl/src/operations/PullOperation.ts
@addons/isl/src/operations/GotoOperation.ts
@addons/isl/src/codeReview/syncStatus.tsx
@addons/isl/src/previews.ts (for dagWithPreviews)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MainBranchSection component</name>
  <files>addons/isl/src/PRDashboard.tsx</files>
  <action>
Create a new MainBranchSection component that shows main branch status:

1. Add imports at top:
   ```typescript
   import {PullOperation} from './operations/PullOperation';
   import {GotoOperation} from './operations/GotoOperation';
   import {dagWithPreviews} from './previews';
   import {succeedableRevset} from './types';
   import {inlineProgressByHash} from './operationsState';
   ```

2. Create MainBranchSection component:
   ```typescript
   function MainBranchSection() {
     const runOperation = useRunOperation();
     const dag = useAtomValue(dagWithPreviews);

     // Find main/master bookmark in the dag
     const mainCommit = dag.resolve('main') ?? dag.resolve('master');
     const remoteName = mainCommit?.remoteBookmarks.find(b =>
       b === 'origin/main' || b === 'origin/master' || b === 'remote/main' || b === 'remote/master'
     ) ?? 'main';

     // Check if we're currently on main
     const currentCommit = dag.resolve('.');
     const isOnMain = currentCommit?.hash === mainCommit?.hash;

     // Get inline progress for feedback
     const inlineProgress = useAtomValue(inlineProgressByHash(mainCommit?.hash ?? ''));

     // Calculate sync status (how far behind remote main we are)
     // This is a simplified version - we check if local main differs from remote main
     const remoteMain = dag.resolve('origin/main') ?? dag.resolve('origin/master');
     const isBehind = remoteMain && mainCommit && remoteMain.hash !== mainCommit.hash;

     const handleGoToMain = useCallback(async () => {
       if (isOnMain && !isBehind) return;

       // Pull first to get latest, then goto
       await runOperation(new PullOperation());
       runOperation(new GotoOperation(succeedableRevset(remoteName)));
     }, [isOnMain, isBehind, runOperation, remoteName]);

     const syncStatusText = isBehind
       ? 'Updates available'
       : isOnMain
         ? 'You are here'
         : 'Up to date';

     return (
       <div className="main-branch-section">
         <div className="main-branch-info">
           <Icon icon="git-branch" />
           <span className="main-branch-name">{remoteName.replace('origin/', '')}</span>
           <span className="main-branch-status">{syncStatusText}</span>
         </div>
         <Tooltip title={isOnMain && !isBehind ? 'Already on main' : 'Pull latest and checkout main'}>
           <Button
             className="main-branch-goto-button"
             onClick={handleGoToMain}
             disabled={isOnMain && !isBehind || inlineProgress != null}
           >
             {inlineProgress ? (
               <Icon icon="loading" />
             ) : (
               <Icon icon="arrow-down" />
             )}
             <T>Go to main</T>
           </Button>
         </Tooltip>
       </div>
     );
   }
   ```

3. Note: The sync status is simplified. A more accurate implementation would count commits between local and remote, but this requires traversing the DAG. The current implementation shows whether there are any updates available.
  </action>
  <verify>TypeScript compiles: cd addons/isl && yarn build</verify>
  <done>MainBranchSection component exists with go-to-main functionality and sync status display</done>
</task>

<task type="auto">
  <name>Task 2: Integrate MainBranchSection into PRDashboard</name>
  <files>addons/isl/src/PRDashboard.tsx</files>
  <action>
Add MainBranchSection to PRDashboard layout:

1. In PRDashboard component, restructure to add main section at top:
   ```typescript
   return (
     <div className="pr-dashboard">
       <div className="pr-dashboard-header">
         {/* existing header content */}
       </div>
       <MainBranchSection />
       <div className="pr-dashboard-content">
         {/* existing stacks content */}
       </div>
     </div>
   );
   ```

2. The MainBranchSection is placed between the header and the scrollable content, so it stays fixed while stacks scroll beneath it.

3. Ensure the component renders even when there are no PR stacks (main branch should always be accessible).
  </action>
  <verify>TypeScript compiles: cd addons/isl && yarn build</verify>
  <done>MainBranchSection appears in PRDashboard between header and stack list</done>
</task>

<task type="auto">
  <name>Task 3: Style MainBranchSection with sticky positioning</name>
  <files>addons/isl/src/PRDashboard.css</files>
  <action>
Add CSS for the main branch section:

1. Main section container (sticky at top):
   ```css
   .main-branch-section {
     position: sticky;
     top: 0;
     z-index: 10;
     display: flex;
     align-items: center;
     justify-content: space-between;
     padding: var(--pad);
     background: var(--graphite-bg, var(--background));
     border-bottom: 1px solid var(--graphite-border, var(--subtle-hover-darken));
     flex-shrink: 0;
   }
   ```

2. Main branch info (left side):
   ```css
   .main-branch-info {
     display: flex;
     align-items: center;
     gap: var(--halfpad);
   }

   .main-branch-name {
     font-weight: 600;
     color: var(--foreground);
   }

   .main-branch-status {
     font-size: 12px;
     color: var(--foreground-sub);
     padding: 2px 6px;
     background: var(--subtle-hover-darken);
     border-radius: 3px;
   }
   ```

3. Go to main button:
   ```css
   .main-branch-goto-button {
     gap: 4px;
   }

   .main-branch-goto-button:disabled {
     opacity: 0.5;
   }
   ```

4. Update pr-dashboard-content to work with sticky:
   ```css
   .pr-dashboard-content {
     flex: 1;
     overflow-y: auto;
     padding: var(--pad);
     /* Ensure this doesn't have overflow:hidden which breaks sticky */
   }
   ```

5. Ensure pr-dashboard doesn't have overflow:hidden (it currently has overflow:hidden, need to change):
   ```css
   .pr-dashboard {
     display: flex;
     flex-direction: column;
     height: 100%;
     /* Remove overflow: hidden to allow sticky to work */
     overflow: visible;
   }
   ```

   Actually, for sticky to work within a scrollable container, the sticky element needs to be inside the scrollable area. Let me revise the approach:

   Change .pr-dashboard to:
   ```css
   .pr-dashboard {
     display: flex;
     flex-direction: column;
     height: 100%;
     overflow-y: auto; /* Make entire dashboard scrollable */
   }
   ```

   And make main-branch-section sticky:
   ```css
   .main-branch-section {
     position: sticky;
     top: 0;
     z-index: 10;
     /* rest of styles */
   }
   ```

   Remove overflow from pr-dashboard-content since parent handles scrolling:
   ```css
   .pr-dashboard-content {
     padding: var(--pad);
   }
   ```
  </action>
  <verify>CSS compiles and main section stays fixed while content scrolls</verify>
  <done>Main branch section has sticky positioning, subtle visual distinction, and proper layout</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd addons/isl && yarn build`
2. Lint passes: `cd addons/isl && yarn eslint`
3. Manual verification:
   - Main section appears at top
   - Main section stays fixed when scrolling stacks
   - Go to main button triggers pull+checkout
   - Sync status shows correctly
</verification>

<success_criteria>
- Main branch section appears fixed at top of stack column
- "Go to main" button pulls and checks out main branch
- Sync status displays (updates available / you are here / up to date)
- Stack items scroll beneath the fixed main section
- Main section has subtle visual distinction from stack cards
</success_criteria>

<output>
After completion, create `.planning/phases/02-stack-column/02-02-SUMMARY.md`
</output>
