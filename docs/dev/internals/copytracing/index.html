<!doctype html><html lang=en dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-dev/internals/copytracing" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.6.3"><title data-rh=true>Bisect-Based Copy Tracing | Sapling</title><meta data-rh=true name=viewport content="width=device-width,initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://sapling-scm.com/docs/dev/internals/copytracing><meta data-rh=true property=og:locale content=en><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="Bisect-Based Copy Tracing | Sapling"><meta data-rh=true name=description content="Copy tracing is a technique used to efficiently account for file copies and"><meta data-rh=true property=og:description content="Copy tracing is a technique used to efficiently account for file copies and"><link data-rh=true rel=icon href=/img/Sapling_favicon-light-green-transparent-big.svg><link data-rh=true rel=canonical href=https://sapling-scm.com/docs/dev/internals/copytracing><link data-rh=true rel=alternate href=https://sapling-scm.com/docs/dev/internals/copytracing hreflang=en><link data-rh=true rel=alternate href=https://sapling-scm.com/docs/dev/internals/copytracing hreflang=x-default><link rel=stylesheet href=/assets/css/styles.061bfe20.css><script src=/assets/js/runtime~main.2fd01531.js defer></script><script src=/assets/js/main.61f9dfc4.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script>
<div style="display: none; text-align: center; background-color: white; color: black;" id=internaldocs-banner></div><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="navbar navbar--fixed-top"><div class=navbar__inner><div class=navbar__items><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><div class=navbar__logo><img src=/img/Sapling_icon-dark-green.svg alt="Sapling Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src=/img/Sapling_icon-dark-green.svg alt="Sapling Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Sapling</b></a><a class="navbar__item navbar__link" href=/docs/introduction/>Documentation</a></div><div class="navbar__items navbar__items--right"><a href=https://github.com/facebook/sapling target=_blank rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type=button disabled title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live=polite aria-pressed=false><svg viewBox="0 0 24 24" width=24 height=24 class=lightToggleIcon_pyhR><path fill=currentColor d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 class=darkToggleIcon_wfgR><path fill=currentColor d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/></svg></button></div><div class=navbarSearchContainer_Bca1><div class=navbar__search><span aria-label="expand searchbar" role=button class=search-icon tabindex=0></span><input id=search_input_react type=search placeholder=Loading... aria-label=Search class="navbar__search-input search-bar" disabled></div></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/docs/category/introduction>Introduction</a><button aria-label="Expand sidebar category 'Introduction'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/docs/category/overview>Overview</a><button aria-label="Expand sidebar category 'Overview'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/docs/category/git-interop>Git Interop</a><button aria-label="Expand sidebar category 'Git Interop'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/docs/category/commands>Commands</a><button aria-label="Expand sidebar category 'Commands'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/docs/category/add-ons>Add-ons</a><button aria-label="Expand sidebar category 'Add-ons'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/docs/category/working-at-scale>Working at Scale</a><button aria-label="Expand sidebar category 'Working at Scale'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/docs/dev/>Developer Guide</a><button aria-label="Collapse sidebar category 'Developer Guide'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/docs/category/process>Process</a><button aria-label="Expand sidebar category 'Process'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" tabindex=0 href=/docs/category/internals>Internals</a><button aria-label="Collapse sidebar category 'Internals'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/docs/dev/internals/copytracing>Bisect-Based Copy Tracing</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/internals/drawdag>DrawDag</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/internals/indexedlog>IndexedLog</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/internals/internal-difference-hg>Internal differences from Mercurial</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/internals/linelog>LineLog</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/internals/metalog>MetaLog</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/internals/visibility-and-mutation>Visibility and mutation</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/docs/dev/internals/zstdelta>ZstDelta</a></ul></ul><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/docs/faqs>FAQs</a></ul></nav></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/docs/dev/><span itemprop=name>Developer Guide</span></a><meta itemprop=position content=1><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/docs/category/internals><span itemprop=name>Internals</span></a><meta itemprop=position content=2><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link itemprop=name>Bisect-Based Copy Tracing</span><meta itemprop=position content=3></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Bisect-Based Copy Tracing</h1></header>
<p><em>Copy tracing</em> is a technique used to efficiently account for file copies and
renames when comparing histories. It is used for <code>diff</code> commands and merge-related
operations, such as <code>rebase</code>, <code>graft</code>, and <code>merge</code>. It simplifies resolving merge conflicts,
especially when large refactors, like directory renames, occur in frequently updated
repositories. Below is an example of a rebase involving file renames:</p>
<div class="language-sl-shell-example codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#bfc7d5;--prism-background-color:#292d3e><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-sl-shell-example codeBlock_bY9V thin-scrollbar" style=color:#bfc7d5;background-color:#292d3e><code class=codeBlockLines_e6Vv><span class=token-line style=color:#bfc7d5><span class="token command shell-prompt">$</span><span class="token command"> </span><span class="token command shell-command">sl</span><span class="token sl-commit-public"></span><br></span><span class=token-line style=color:#bfc7d5><span class="token sl-commit-public"></span><span class="token sl-commit-public sl-commit-current sl-commit-meta">@</span><span class="token sl-commit-public sl-commit-current sl-commit-meta sl-hash">  d78558192 </span><span class="token sl-commit-public sl-commit-current sl-commit-meta"> 1 second ago  alyssa</span><span class="token sl-commit-public sl-commit-current"></span><br></span><span class=token-line style=color:#bfc7d5><span class="token sl-commit-public sl-commit-current">│</span><span class="token sl-commit-public sl-commit-current sl-commit-text">  update b</span><span class="token plain"></span><br></span><span class=token-line style=color:#bfc7d5><span class="token plain"></span><span class="token output">│</span><span class="token sl-commit-public"></span><br></span><span class=token-line style=color:#bfc7d5><span class="token sl-commit-public"></span><span class="token sl-commit-public sl-commit-other sl-commit-meta">o</span><span class="token sl-commit-public sl-commit-other sl-commit-meta sl-hash">  2b089a0d8 </span><span class="token sl-commit-public sl-commit-other sl-commit-meta"> 15 seconds ago  alyssa</span><span class="token sl-commit-public sl-commit-other"></span><br></span><span class=token-line style=color:#bfc7d5><span class="token sl-commit-public sl-commit-other">│</span><span class="token sl-commit-public sl-commit-other sl-commit-text">  mv a -> b</span><span class="token plain"></span><br></span><span class=token-line style=color:#bfc7d5><span class="token plain"></span><span class="token output">│</span><br></span><span class=token-line style=color:#bfc7d5><span class="token output">│</span><span class="token sl-commit-draft"> </span><span class="token sl-commit-draft sl-commit-other sl-commit-meta">o</span><span class="token sl-commit-draft sl-commit-other sl-commit-meta sl-hash">  b0d1b083d </span><span class="token sl-commit-draft sl-commit-other sl-commit-meta"> 36 seconds ago  alyssa</span><span class="token sl-commit-draft sl-commit-other"></span><br></span><span class=token-line style=color:#bfc7d5><span class="token sl-commit-draft sl-commit-other">├─╯</span><span class="token sl-commit-draft sl-commit-other sl-commit-text">  update a</span><span class="token plain"></span><br></span><span class=token-line style=color:#bfc7d5><span class="token plain"></span><span class="token output">│</span><span class="token sl-commit-public"></span><br></span><span class=token-line style=color:#bfc7d5><span class="token sl-commit-public"></span><span class="token sl-commit-public sl-commit-other sl-commit-meta">o</span><span class="token sl-commit-public sl-commit-other sl-commit-meta sl-hash">  5b0d97d5a </span><span class="token sl-commit-public sl-commit-other sl-commit-meta"> 46 seconds ago  alyssa</span><span class="token sl-commit-public sl-commit-other"></span><br></span><span class=token-line style=color:#bfc7d5><span class="token sl-commit-public sl-commit-other"></span><span class="token sl-commit-public sl-commit-other sl-commit-text">   add a</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>Without copy tracing, <code>sl</code> previously had to ask about renamed or copied files
during rebases:</p>
<div class="language-sl-shell-example codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#bfc7d5;--prism-background-color:#292d3e><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-sl-shell-example codeBlock_bY9V thin-scrollbar" style=color:#bfc7d5;background-color:#292d3e><code class=codeBlockLines_e6Vv><span class=token-line style=color:#bfc7d5><span class="token command shell-prompt">$</span><span class="token command"> </span><span class="token command shell-command">sl rebase -s b0d1b083d -d d78558192</span><span class="token plain"></span><br></span><span class=token-line style=color:#bfc7d5><span class="token plain"></span><span class="token output">rebasing b0d1b083d791 "update a"</span><br></span><span class=token-line style=color:#bfc7d5><span class="token output">other [source (being rebased)] changed a which local [dest (rebasing onto)] is missing</span><br></span><span class=token-line style=color:#bfc7d5><span class="token output">hint: if this is due to a renamed file, you can manually input the renamed path</span><br></span><span class=token-line style=color:#bfc7d5><span class="token output">use (c)hanged version, leave (d)eleted, or leave (u)nresolved, or input (r)enamed path?</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>With copy tracing, the merge <em>just works</em>, despite there being copied or renamed
files:</p>
<div class="language-sl-shell-example codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#bfc7d5;--prism-background-color:#292d3e><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-sl-shell-example codeBlock_bY9V thin-scrollbar" style=color:#bfc7d5;background-color:#292d3e><code class=codeBlockLines_e6Vv><span class=token-line style=color:#bfc7d5><span class="token command shell-prompt">$</span><span class="token command"> </span><span class="token command shell-command">sl rebase -s b0d1b083d -d d78558192</span><span class="token plain"></span><br></span><span class=token-line style=color:#bfc7d5><span class="token plain"></span><span class="token output">rebasing b0d1b083d791 "update a"</span><br></span><span class=token-line style=color:#bfc7d5><span class="token output">merging b and a to b</span><br></span><span class=token-line style=color:#bfc7d5><span class="token output">b0d1b083d791 -> 92444cbb366b "update a"</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=background>Background<a href=#background class=hash-link aria-label="Direct link to Background" title="Direct link to Background">​</a></h2>
<p>Historically, Sapling has used two copy-tracing solutions. However, as our
monorepos grow (<a href=https://engineering.fb.com/2022/11/15/open-source/sapling-source-control-scalable/ target=_blank rel="noopener noreferrer">tens of millions of files, tens of millions of commits</a>),
the previous solutions have become too slow for production use:</p>
<ul>
<li><strong>Full copy tracing</strong> finds all the new files (M) that were added from
merge base up to the top commit and for each file it checks if this file
was copied from another file (N). For each pair of files, Sapling was walking
through the file history (H) to check the copy-from the relationship.<!-- -->
<ul>
<li>The time complexity of this algorithm is <code>O(M * N * H)</code>, where N and H are huge.<!-- -->
<ul>
<li>Typically M (source) &lt;&lt; N (destination)</li>
</ul>
</li>
<li>Sapling records rename information directly in file headers, eliminating the
need to compute file content similarity, which is different from Git's approach.</li>
</ul>
</li>
<li><strong>Heuristics copy tracing</strong> assumes that moves or renames fall into one of two
categories: (1) Within the same directory (same directory name but different
file names); (2) Move from one directory to another (same file names but
different directory names)<!-- -->
<ul>
<li>This approach reduces N to K (K is a configured constant value), resulting
in a time complexity of <code>O(M * H)</code>, where H remains large and there is a large
constant factor for reducing N to K.</li>
<li>Another issue is that if the renames do not match the heuristics, they
cannot be found.</li>
</ul>
</li>
</ul>
<p>Before we explore bisect-based copy tracing, let's first examine how
<a href=https://github.com/newren/presentations/blob/pdfs/merge-performance/merge-performance-slides.pdf target=_blank rel="noopener noreferrer">Git's rename detection</a>
works. Git's rename detection is similar to the heuristics copy tracing
mentioned earlier, but it includes additional heuristics and strategies
to enhance performance, such as "Remembering previous work", "Exact renames".</p>
<ul>
<li>The time complexity is <code>O(M * S)</code>, where M is the same as above,
S is the complexity of file content similarity computation.</li>
<li>It also shares the disadvantage of Sapling heuristics copy tracing
when renames do not match heuristics. Otherwise, the time complexity
will be <code>O(M * N * S)</code>.</li>
</ul>
<p>Bisect-based copy tracing is built to achieve the following desired properties:</p>
<ul>
<li><strong>Scalability</strong>: <code>O(M * log H)</code> time complexity, it bisects the file history
rather than scanning commits sequentially.</li>
<li><strong>Flexibility</strong>: Not restricted by heuristics like 'Move from one directory to another'.</li>
<li><strong>Abstracted</strong>: Support both Sapling and Git backend repositories.</li>
<li><strong>Efficiency</strong>: Provides fast content similarity checks for cases where renames
are not recorded in Sapling or when working with Git repositories.</li>
<li><strong>User-Friendly</strong>: Informative message when renames cannot be found, such as
delete/modified conflicts.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=how>How?<a href=#how class=hash-link aria-label="Direct link to How?" title="Direct link to How?">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=scalability>Scalability<a href=#scalability class=hash-link aria-label="Direct link to Scalability" title="Direct link to Scalability">​</a></h3>
<p>The problem that copy tracing solves is: <strong>given two commits, C1 and C2, and a path P1 in C1, we need to find the renamed path P2 in C2</strong>.</p>
<p>This problem required a new algorithmic design to scale efficiently. The
basic idea is to break the problem into two steps:</p>
<ul>
<li>Bisect a commit <code>C3</code> that deletes <code>P1</code> in the <code>C1</code> to <code>C2</code> range.</li>
<li>Examine <code>C3</code>, find what path <code>P1</code> was renamed to. If that path exists in <code>C2</code>,
then we’re done. Otherwise recursively trace renames in the <code>C3</code> to <code>C2</code> range.</li>
</ul>
<p>The efficient bisect is based on the <a href=https://github.com/facebook/sapling/blob/main/eden/scm/slides/201904-segmented-changelog/segmented-changelog.pdf target=_blank rel="noopener noreferrer">Segmented Changelog</a> we developed for lazy commit graph downloading and improving DAG operations,
please check <a href=https://engineering.fb.com/2022/11/15/open-source/sapling-source-control-scalable/ target=_blank rel="noopener noreferrer">this blog post</a>
to learn more about Segmented Changelog.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=flexibility>Flexibility<a href=#flexibility class=hash-link aria-label="Direct link to Flexibility" title="Direct link to Flexibility">​</a></h3>
<p>Since Sapling can efficiently trace rename commits by bisecting the history,
and then find the renames in a rename commit, we don't need heuristics to
reduce the large number N on destination side. This approach allows Sapling
to detect renames that would otherwise be missed by heuristics-based methods.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=abstracted>Abstracted<a href=#abstracted class=hash-link aria-label="Direct link to Abstracted" title="Direct link to Abstracted">​</a></h3>
<p>We made the rename detection inside a commit abstracted. Whether it’s Sapling’s
tracked rename, or Git’s implicit content similar rename, or a combination
of them, they fit in the same abstraction and can be flexibly configured.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=efficiency>Efficiency<a href=#efficiency class=hash-link aria-label="Direct link to Efficiency" title="Direct link to Efficiency">​</a></h3>
<p>Typical content similarity libraries often degrade to <code>O(N^2)</code> in the worst case,
where N is the line count (<code>O(N^2)</code> is the worst case for the Myers diff algorithm).
Our approach, <code>xdiff::edit_cost</code>, imposes a <code>max cost</code> limit, reducing the
complexity to <code>O(N)</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=user-friendly>User-Friendly<a href=#user-friendly class=hash-link aria-label="Direct link to User-Friendly" title="Direct link to User-Friendly">​</a></h3>
<p>When renames cannot be found, for example, file <code>a.txt</code> was renamed to <code>a.md</code>
and then deleted on the destination branch, the new copy tracing can identify
both the commit that renamed the file and also the commit that eventually
deleted it. This allows us to provide additional context to help resolve the
conflict:</p>
<div class="language-sl-shell-example codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#bfc7d5;--prism-background-color:#292d3e><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-sl-shell-example codeBlock_bY9V thin-scrollbar" style=color:#bfc7d5;background-color:#292d3e><code class=codeBlockLines_e6Vv><span class=token-line style=color:#bfc7d5><span class="token command shell-prompt">$</span><span class="token command"> </span><span class="token command shell-command">sl rebase -s 108b59d42 -d a1fcdc96b</span><span class="token plain"></span><br></span><span class=token-line style=color:#bfc7d5><span class="token plain"></span><span class="token output">...</span><br></span><span class=token-line style=color:#bfc7d5><span class="token output">other [source (being rebased)] changed a.txt which local [dest (rebasing onto)] is missing</span><br></span><span class=token-line style=color:#bfc7d5><span class="token output">hint: the missing file was probably deleted by commit 7f48dc97d540 with name 'a.md' in the branch rebasing onto</span><br></span><span class=token-line style=color:#bfc7d5><span class="token output">use (c)hanged version, leave (d)eleted, or leave (u)nresolved, or input (r)enamed path?</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label="Copy code to clipboard" title=Copy class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class=col><a href=https://github.com/facebook/sapling/tree/main/website/docs/dev/internals/copytracing.md target=_blank rel="noopener noreferrer" class=theme-edit-this-page><svg fill=currentColor height=20 width=20 viewBox="0 0 40 40" class=iconEdit_Z9Sw aria-hidden=true><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"/></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href=/docs/category/internals><div class=pagination-nav__sublabel>Previous</div><div class=pagination-nav__label>Internals</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/docs/dev/internals/drawdag><div class=pagination-nav__sublabel>Next</div><div class=pagination-nav__label>DrawDag</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#background class="table-of-contents__link toc-highlight">Background</a><li><a href=#how class="table-of-contents__link toc-highlight">How?</a><ul><li><a href=#scalability class="table-of-contents__link toc-highlight">Scalability</a><li><a href=#flexibility class="table-of-contents__link toc-highlight">Flexibility</a><li><a href=#abstracted class="table-of-contents__link toc-highlight">Abstracted</a><li><a href=#efficiency class="table-of-contents__link toc-highlight">Efficiency</a><li><a href=#user-friendly class="table-of-contents__link toc-highlight">User-Friendly</a></ul></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class=footer__title>Useful Links</div><ul class="footer__items clean-list"><li class=footer__item><a href=https://github.com/facebook/sapling target=_blank rel="noopener noreferrer" class=footer__link-item>GitHub<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://discord.gg/X6baZ94Vzh target=_blank rel="noopener noreferrer" class=footer__link-item>Discord<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://twitter.com/MetaOpenSource target=_blank rel="noopener noreferrer" class=footer__link-item>Twitter<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://opensource.fb.com/ target=_blank rel="noopener noreferrer" class=footer__link-item>Meta Open Source<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a></ul></div><div class="col footer__col"><div class=footer__title>Related Projects</div><ul class="footer__items clean-list"><li class=footer__item><a href=https://github.com/ezyang/ghstack target=_blank rel="noopener noreferrer" class=footer__link-item>ghstack<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://github.com/facebook/watchman target=_blank rel="noopener noreferrer" class=footer__link-item>Watchman<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://github.com/facebookexperimental/fb-vscode target=_blank rel="noopener noreferrer" class=footer__link-item>VS Code @ Meta<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a></ul></div><div class="col footer__col"><div class=footer__title>Legal</div><ul class="footer__items clean-list"><li class=footer__item><a href=https://opensource.fb.com/legal/privacy/ target=_blank rel="noopener noreferrer" class=footer__link-item>Privacy<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://opensource.fb.com/legal/terms/ target=_blank rel="noopener noreferrer" class=footer__link-item>Terms<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://opensource.fb.com/legal/data-policy/ target=_blank rel="noopener noreferrer" class=footer__link-item>Data Policy<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a><li class=footer__item><a href=https://opensource.fb.com/legal/cookie-policy/ target=_blank rel="noopener noreferrer" class=footer__link-item>Cookie Policy<svg width=13.5 height=13.5 aria-hidden=true viewBox="0 0 24 24" class=iconExternalLink_nPIU><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></svg></a></ul></div></div><div class="footer__bottom text--center"><div class=margin-bottom--sm><a href=https://opensource.fb.com rel="noopener noreferrer" class=footerLogoLink_BH7S><img src=/img/meta_opensource_logo_negative.svg alt="Meta Open Source Logo" class="footer__logo themedComponent_mlkZ themedComponent--light_NVdE"><img src=/img/meta_opensource_logo_negative.svg alt="Meta Open Source Logo" class="footer__logo themedComponent_mlkZ themedComponent--dark_xIcU"></a></div><div class=footer__copyright>Copyright © 2025 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>