name: Deploy ReviewStack to Cloudflare Pages

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'eden/contrib/reviewstack/**'
      - 'eden/contrib/reviewstack.dev/**'
      - 'eden/contrib/shared/**'
      - '.github/workflows/reviewstack.dev-deploy.yml'

jobs:
  deploy:
    runs-on: ubuntu-22.04
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'
          cache-dependency-path: eden/contrib/yarn.lock
      - name: Install dependencies
        working-directory: ./eden/contrib/
        run: yarn install

      # Build codegen and then do some sanity checks so we don't push the site
      # when the tests are broken.
      - name: GraphQL/TextMate codegen
        working-directory: ./eden/contrib/reviewstack
        run: yarn codegen
      - name: ESLint
        working-directory: ./eden/contrib/reviewstack
        run: yarn eslint
      - name: Unit tests
        working-directory: ./eden/contrib/reviewstack
        run: yarn test --watchAll=false
      - name: Build the static site
        working-directory: ./eden/contrib/reviewstack.dev
        run: yarn release

      # Deploy to Cloudflare Pages
      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy ./eden/contrib/reviewstack.dev/build --project-name=reviewstack
