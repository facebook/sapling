name: EdenSCM Rust Libraries

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Run auth tests
      run: cargo test --verbose --target-dir target --manifest-path auth/Cargo.toml
    - name: Run backingstore tests
      run: cargo test --verbose --target-dir target --manifest-path backingstore/Cargo.toml
    - name: Run blackbox tests
      run: cargo test --verbose --target-dir target --manifest-path blackbox/Cargo.toml
    - name: Run bookmarkstore tests
      run: cargo test --verbose --target-dir target --manifest-path bookmarkstore/Cargo.toml
    # thrift-types does not build
    # - name: Run clidispatch tests
    #  run: cargo test --verbose --target-dir target --manifest-path clidispatch/Cargo.toml
    - name: Run cliparser tests
      run: cargo test --verbose --target-dir target --manifest-path cliparser/Cargo.toml
    # openssl does not build
    # - name: Run commitcloudsubscriber tests
    #   run: cargo test --verbose --target-dir target --manifest-path commitcloudsubscriber/Cargo.toml
    - name: Run configparser tests
      run: cargo test --verbose --target-dir target --manifest-path configparser/Cargo.toml
    - name: Run cpython-ext tests
      run: cargo test --verbose --target-dir target --manifest-path cpython-ext/Cargo.toml
    - name: Run dag tests
      run: cargo test --verbose --target-dir target --manifest-path dag/Cargo.toml
    - name: Run drawdag tests
      run: cargo test --verbose --target-dir target --manifest-path drawdag/Cargo.toml
    - name: Run edenapi tests
      run: cargo test --verbose --target-dir target --manifest-path edenapi/Cargo.toml
    - name: Run edenfs-client tests
      run: cargo test --verbose --target-dir target --manifest-path edenfs-client/Cargo.toml
    - name: Run encoding tests
      run: cargo test --verbose --target-dir target --manifest-path encoding/Cargo.toml
    # clidispatch does not build
    # - name: Run hgcommands tests
    #   run: cargo test --verbose --target-dir target --manifest-path hgcommands/Cargo.toml
    - name: Run hgtime tests
      run: cargo test --verbose --target-dir target --manifest-path hgtime/Cargo.toml
    - name: Run indexedlog tests
      run: cargo test --verbose --target-dir target --manifest-path indexedlog/Cargo.toml
    - name: Run lz4-pyframe tests
      run: cargo test --verbose --target-dir target --manifest-path lz4-pyframe/Cargo.toml
    - name: Run manifest tests
      run: cargo test --verbose --target-dir target --manifest-path manifest/Cargo.toml
    - name: Run manifest-tree tests
      run: cargo test --verbose --target-dir target --manifest-path manifest-tree/Cargo.toml
    - name: Run metalog tests
      run: cargo test --verbose --target-dir target --manifest-path metalog/Cargo.toml
    - name: Run mincode tests
      run: cargo test --verbose --target-dir target --manifest-path mincode/Cargo.toml
    - name: Run minibench tests
      run: cargo test --verbose --target-dir target --manifest-path minibench/Cargo.toml
    - name: Run minibytes tests
      run: cargo test --verbose --target-dir target --manifest-path minibytes/Cargo.toml
    - name: Run mpatch tests
      run: cargo test --verbose --target-dir target --manifest-path mpatch/Cargo.toml
    - name: Run mpatch-sys tests
      run: cargo test --verbose --target-dir target --manifest-path mpatch-sys/Cargo.toml
    - name: Run mutationstore tests
      run: cargo test --verbose --target-dir target --manifest-path mutationstore/Cargo.toml
    - name: Run nodemap tests
      run: cargo test --verbose --target-dir target --manifest-path nodemap/Cargo.toml
    - name: Run pathmatcher tests
      run: cargo test --verbose --target-dir target --manifest-path pathmatcher/Cargo.toml
    - name: Run procinfo tests
      run: cargo test --verbose --target-dir target --manifest-path procinfo/Cargo.toml
    - name: Run radixbuf tests
      run: cargo test --verbose --target-dir target --manifest-path radixbuf/Cargo.toml
    - name: Run renderdag tests
      run: cargo test --verbose --target-dir target --manifest-path renderdag/Cargo.toml
    - name: Run revisionstore tests
      run: cargo test --verbose --target-dir target --manifest-path revisionstore/Cargo.toml
    - name: Run stackdesc tests
      run: cargo test --verbose --target-dir target --manifest-path stackdesc/Cargo.toml
    # fbthrift is not published
    # - name: Run thrift-types tests
    #  run: cargo test --verbose --target-dir target --manifest-path thrift-types/Cargo.toml
    - name: Run tracing-collector tests
      run: cargo test --verbose --target-dir target --manifest-path tracing-collector/Cargo.toml
    - name: Run treestate tests
      run: cargo test --verbose --target-dir target --manifest-path treestate/Cargo.toml
    - name: Run types tests
      run: cargo test --verbose --target-dir target --manifest-path types/Cargo.toml
    - name: Run util tests
      run: cargo test --verbose --target-dir target --manifest-path util/Cargo.toml
    - name: Run vlqencoding tests
      run: cargo test --verbose --target-dir target --manifest-path vlqencoding/Cargo.toml
    - name: Run workingcopy tests
      run: cargo test --verbose --target-dir target --manifest-path workingcopy/Cargo.toml
    - name: Run xdiff tests
      run: cargo test --verbose --target-dir target --manifest-path xdiff/Cargo.toml
    - name: Run xdiff-sys tests
      run: cargo test --verbose --target-dir target --manifest-path xdiff-sys/Cargo.toml
    - name: Run zstdelta tests
      run: cargo test --verbose --target-dir target --manifest-path zstdelta/Cargo.toml
    - name: Run zstore tests
      run: cargo test --verbose --target-dir target --manifest-path zstore/Cargo.toml
