# This file was @generated by getdeps.py

name: EdenFS Linux

on:
  push:
    branches:
    - main
  pull_request:
    branches:
    - main

permissions:
  contents: read  #  to fetch code (actions/checkout)

jobs:
  build:
    runs-on: ubuntu-20.04
    steps:
    - uses: actions/checkout@v4
    - name: Show disk space at start
      run: df -h
    - name: Free up disk space
      run: sudo rm -rf /usr/local/lib/android
    - name: Show disk space after freeing up
      run: df -h
    - name: Update system package info
      run: sudo apt-get update
    - name: Install system deps
      run: sudo python3 build/fbcode_builder/getdeps.py --allow-system-packages install-system-deps --recursive eden
    - name: Install packaging system deps
      run: sudo python3 build/fbcode_builder/getdeps.py --allow-system-packages install-system-deps --recursive patchelf
    - name: Install Rust Stable
      uses: dtolnay/rust-toolchain@stable
    - name: Fetch ninja
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests ninja
    - name: Fetch cmake
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests cmake
    - name: Fetch blake3
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests blake3
    - name: Fetch cpptoml
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests cpptoml
    - name: Fetch fmt
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests fmt
    - name: Fetch gflags
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests gflags
    - name: Fetch glog
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests glog
    - name: Fetch googletest
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests googletest
    - name: Fetch python-six
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests python-six
    - name: Fetch zstd
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests zstd
    - name: Fetch boost
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests boost
    - name: Fetch double-conversion
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests double-conversion
    - name: Fetch libevent
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests libevent
    - name: Fetch lz4
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests lz4
    - name: Fetch snappy
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests snappy
    - name: Fetch libgit2
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests libgit2
    - name: Fetch python-ptyprocess
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests python-ptyprocess
    - name: Fetch pexpect
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests pexpect
    - name: Fetch bz2
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests bz2
    - name: Fetch python-filelock
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests python-filelock
    - name: Fetch python-toml
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests python-toml
    - name: Fetch re2
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests re2
    - name: Fetch rocksdb
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests rocksdb
    - name: Fetch sqlite3
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests sqlite3
    - name: Fetch zlib
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests zlib
    - name: Fetch autoconf
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests autoconf
    - name: Fetch automake
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests automake
    - name: Fetch libtool
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests libtool
    - name: Fetch nghttp2
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests nghttp2
    - name: Fetch libcurl
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests libcurl
    - name: Fetch libffi
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests libffi
    - name: Fetch ncurses
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests ncurses
    - name: Fetch python
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests python
    - name: Fetch libsodium
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests libsodium
    - name: Fetch xz
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests xz
    - name: Fetch folly
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests folly
    - name: Fetch fizz
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests fizz
    - name: Fetch mvfst
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests mvfst
    - name: Fetch wangle
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests wangle
    - name: Fetch fbthrift
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests fbthrift
    - name: Fetch fb303
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests fb303
    - name: Fetch rust-shed
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests rust-shed
    - name: Fetch edencommon
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fetch --no-tests edencommon
    - name: Build ninja
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests ninja
    - name: Build cmake
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests cmake
    - name: Build blake3
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests blake3
    - name: Build cpptoml
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests cpptoml
    - name: Build fmt
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests fmt
    - name: Build gflags
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests gflags
    - name: Build glog
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests glog
    - name: Build googletest
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests googletest
    - name: Build python-six
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests python-six
    - name: Build zstd
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests zstd
    - name: Build boost
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests boost
    - name: Build double-conversion
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests double-conversion
    - name: Build libevent
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests libevent
    - name: Build lz4
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests lz4
    - name: Build snappy
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests snappy
    - name: Build libgit2
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests libgit2
    - name: Build python-ptyprocess
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests python-ptyprocess
    - name: Build pexpect
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests pexpect
    - name: Build bz2
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests bz2
    - name: Build python-filelock
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests python-filelock
    - name: Build python-toml
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests python-toml
    - name: Build re2
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests re2
    - name: Build rocksdb
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests rocksdb
    - name: Build sqlite3
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests sqlite3
    - name: Build zlib
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests zlib
    - name: Build autoconf
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests autoconf
    - name: Build automake
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests automake
    - name: Build libtool
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests libtool
    - name: Build nghttp2
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests nghttp2
    - name: Build libcurl
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests libcurl
    - name: Build libffi
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests libffi
    - name: Build ncurses
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests ncurses
    - name: Build python
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests python
    - name: Build libsodium
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests libsodium
    - name: Build xz
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests xz
    - name: Build folly
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests folly
    - name: Build fizz
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests fizz
    - name: Build mvfst
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests mvfst
    - name: Build wangle
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests wangle
    - name: Build fbthrift
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests fbthrift
    - name: Build fb303
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests fb303
    - name: Build rust-shed
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests rust-shed
    - name: Build edencommon
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --free-up-disk --no-tests edencommon
    - name: Build eden
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages build --no-tests --src-dir=. eden  --project-install-prefix eden:/usr/local
    - name: Copy artifacts
      run: python3 build/fbcode_builder/getdeps.py --allow-system-packages fixup-dyn-deps --strip --src-dir=. eden _artifacts/linux  --project-install-prefix eden:/usr/local --final-install-prefix /usr/local
    - uses: actions/upload-artifact@v2
      with:
        name: eden
        path: _artifacts
    - name: Show disk space at end
      run: df -h
